{% extends 'juice_app/base.html' %}
{% load static %}
{% load custom_filters %}
{% block title %}Inventory Report | Fruit Juice Production{% endblock %}

{% block extra_css %}
<style>
  .report-card {
    transition: all 0.2s ease;
  }
  
  .report-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
  }
  
  .inventory-status {
    width: 12px;
    height: 12px;
    display: inline-block;
    border-radius: 50%;
    margin-right: 8px;
  }
  
  .status-good {
    background-color: var(--success);
  }
  
  .status-warning {
    background-color: var(--warning);
  }
  
  .status-critical {
    background-color: var(--danger);
  }
  
  .report-filters {
    background-color: var(--color-50);
    border-radius: 0.5rem;
    padding: 1.25rem;
    margin-bottom: 1.5rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1>Inventory Report</h1>
    <p class="text-muted">Comprehensive view of current inventory status and valuation</p>
  </div>
  <div>
    <div class="dropdown d-inline-block me-2">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="material-icons align-middle">file_download</i> Export
      </button>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="exportDropdown">
        <li><a class="dropdown-item" href="#"><i class="material-icons align-middle me-2" style="font-size: 16px;">description</i> PDF</a></li>
        <li><a class="dropdown-item" href="#"><i class="material-icons align-middle me-2" style="font-size: 16px;">table_chart</i> Excel</a></li>
        <li><a class="dropdown-item" href="#"><i class="material-icons align-middle me-2" style="font-size: 16px;">print</i> Print</a></li>
      </ul>
    </div>
    <a href="{% url 'dashboard' %}" class="btn btn-outline-primary">
      <i class="material-icons align-middle">dashboard</i> Dashboard
    </a>
  </div>
</div>

{% comment %} <div class="report-filters">
  <form method="get" class="mb-0">
    <div class="row align-items-end">
      <div class="col-md-3">
        <div class="form-group mb-md-0 mb-3">
          <label for="inventory_type" class="form-label">Inventory Type</label>
          <select id="inventory_type" name="type" class="form-select">
            <option value="all" {% if inventory_type == 'all' %}selected{% endif %}>All Inventory</option>
            <option value="raw_materials" {% if inventory_type == 'raw_materials' %}selected{% endif %}>Raw Materials</option>
            <option value="products" {% if inventory_type == 'products' %}selected{% endif %}>Finished Products</option>
          </select>
        </div>
      </div>
      <div class="col-md-3">
        <div class="form-group mb-md-0 mb-3">
          <label for="status_filter" class="form-label">Stock Status</label>
          <select id="status_filter" name="status" class="form-select">
            <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Status</option>
            <option value="in_stock" {% if status_filter == 'in_stock' %}selected{% endif %}>In Stock</option>
            <option value="low_stock" {% if status_filter == 'low_stock' %}selected{% endif %}>Low Stock</option>
            <option value="out_of_stock" {% if status_filter == 'out_of_stock' %}selected{% endif %}>Out of Stock</option>
          </select>
        </div>
      </div>
      <div class="col-md-3">
        <div class="form-group mb-md-0 mb-3">
          <label for="sort_by" class="form-label">Sort By</label>
          <select id="sort_by" name="sort" class="form-select">
            <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Name</option>
            <option value="stock_level" {% if sort_by == 'stock_level' %}selected{% endif %}>Stock Level</option>
            <option value="value" {% if sort_by == 'value' %}selected{% endif %}>Value</option>
          </select>
        </div>
      </div>
      <div class="col-md-3 text-md-end">
        <button type="submit" class="btn btn-primary px-4">
          <i class="material-icons align-middle me-1">filter_list</i> Apply Filters
        </button>
        <a href="{% url 'inventory_report' %}" class="btn btn-outline-secondary">Reset</a>
      </div>
    </div>
  </form>
</div> {% endcomment %}

<!-- Inventory Summary Cards -->
<div class="row mb-4">
  <div class="col-md-4 mb-3">
    <div class="card report-card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-1">Raw Materials Inventory</h6>
            <h2 class="mb-0">GHS{{ raw_materials|length|multiply:0|floatformat:2 }}</h2>
            <p class="text-muted mb-0">{{ raw_materials|length }} unique materials</p>
          </div>
          <div style="width: 48px; height: 48px; background-color: var(--color-100); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
            <i class="material-icons" style="font-size: 28px; color: var(--color-700);">inventory</i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-4 mb-3">
    <div class="card report-card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-1">Finished Products Inventory</h6>
            <h2 class="mb-0">GHS{{ products|length|multiply:0|floatformat:2 }}</h2>
            <p class="text-muted mb-0">{{ products|length }} unique products</p>
          </div>
          <div style="width: 48px; height: 48px; background-color: var(--color-100); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
            <i class="material-icons" style="font-size: 28px; color: var(--color-700);">local_drink</i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-4 mb-3">
    <div class="card report-card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-1">Total Inventory Value</h6>
            <h2 class="mb-0">GHS{{ top_materials_by_value.0.total_value|add:top_products_by_value.0.total_value|floatformat:2 }}</h2>
            <p class="text-muted mb-0">As of {{ report_date }}</p>
          </div>
          <div style="width: 48px; height: 48px; background-color: var(--color-100); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
            <i class="material-icons" style="font-size: 28px; color: var(--color-700);">savings</i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Raw Materials Inventory</h5>
        <div class="d-flex align-items-center">
          <div class="me-3">
            <span class="inventory-status status-good"></span> Normal
          </div>
          <div class="me-3">
            <span class="inventory-status status-warning"></span> Low
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        {% if raw_materials %}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th>Name</th>
                <th>Current Stock</th>
                <th>Reorder Level</th>
                <th>Unit</th>
                <th>Unit Cost</th>
                <th>Total Value</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for material in raw_materials %}
              <tr {% if material.needs_reorder %}class="table-warning"{% endif %}>
                <td>
                  <a href="{% url 'raw_material_detail' material.id %}">{{ material.name }}</a>
                </td>
                <td>{{ material.quantity_in_stock }}</td>
                <td>{{ material.reorder_level }}</td>
                <td>{{ material.unit }}</td>
                <td>GHS{{ material.unit_cost|floatformat:2 }}</td>
                <td>GHS{{ material.quantity_in_stock|multiply:material.unit_cost|floatformat:2 }}</td>
                <td>
                  {% if material.needs_reorder %}
                  <span class="inventory-status status-warning"></span> Low
                  {% else %}
                  <span class="inventory-status status-good"></span> Normal
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center py-4">
          <p class="text-muted">No raw materials found</p>
        </div>
        {% endif %}
      </div>
    </div>
    
    <div class="card mt-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Products Inventory</h5>
        <div class="d-flex align-items-center">
          <div class="me-3">
            <span class="inventory-status status-good"></span> Normal
          </div>
          <div class="me-3">
            <span class="inventory-status status-warning"></span> Low
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        {% if products %}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th>Name</th>
                <th>SKU</th>
                <th>Current Stock</th>
                <th>Selling Price</th>
                <th>Total Value</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for product in products %}
              <tr {% if product.stock_quantity < 10 %}class="table-warning"{% endif %}>
                <td>
                  <a href="{% url 'product_detail' product.id %}">{{ product.name }}</a>
                </td>
                <td>{{ product.sku }}</td>
                <td>{{ product.stock_quantity }}</td>
                <td>GHS{{ product.selling_price|floatformat:2 }}</td>
                <td>GHS{{ product.stock_quantity|multiply:product.selling_price|floatformat:2 }}</td>
                <td>
                  {% if product.stock_quantity < 10 %}
                  <span class="inventory-status status-warning"></span> Low
                  {% else %}
                  <span class="inventory-status status-good"></span> Normal
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center py-4">
          <p class="text-muted">No products found</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  
  <div class="col-md-4">
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Top Materials by Value</h5>
      </div>
      <div class="card-body">
        <div style="height: 250px;">
          <canvas id="topMaterialsChart"></canvas>
        </div>
        <div class="mt-3">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Material</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>
              {% for material in top_materials_by_value %}
              <tr>
                <td>{{ material.name }}</td>
                <td>GHS{{ material.total_value|floatformat:2 }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Low Stock Items</h5>
      </div>
      <div class="card-body p-0">
        {% if low_stock_materials %}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th>Item</th>
                <th>Current</th>
                <th>Reorder</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for material in low_stock_materials %}
              <tr>
                <td>{{ material.name }}</td>
                <td class="text-danger fw-bold">{{ material.quantity_in_stock }}</td>
                <td>{{ material.reorder_level }}</td>
                <td>
                  <a href="{% url 'purchase_order_new' %}?material={{ material.id }}" class="btn btn-sm btn-outline-primary">
                    <i class="material-icons" style="font-size: 14px;">shopping_cart</i> Order
                  </a>
                </td>
              </tr>
              {% endfor %}
              {% for product in low_stock_products %}
              <tr>
                <td>{{ product.name }}</td>
                <td class="text-danger fw-bold">{{ product.stock_quantity }}</td>
                <td>10</td>
                <td>
                  <a href="{% url 'production_new' %}?product={{ product.id }}" class="btn btn-sm btn-outline-primary">
                    <i class="material-icons" style="font-size: 14px;">science</i> Produce
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center py-4">
          <p class="text-muted">No low stock items found</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Get CSS variables for chart colors
    const style = getComputedStyle(document.documentElement);
    const colorPrimary = style.getPropertyValue('--color-600');
    const colorSecondary = style.getPropertyValue('--color-300');
    
    // Function to generate distinct colors
    function generateColors(numColors) {
      const colors = [];
      const baseHue = 10; // Red/orange hue
      const saturation = 70;
      
      for (let i = 0; i < numColors; i++) {
        // Vary the hue slightly for each segment
        const hue = (baseHue + (i * 35)) % 360;
        colors.push(`hsl(${hue}, ${saturation}%, 55%)`);
      }
      
      return colors;
    }
    
    // Top Materials by Value Chart
    const topMaterialsCtx = document.getElementById('topMaterialsChart').getContext('2d');
    const topMaterialsChart = new Chart(topMaterialsCtx, {
      type: 'pie',
      data: {
        labels: [
          {% for material in top_materials_by_value %}
            "{{ material.name }}",
          {% endfor %}
        ],
        datasets: [
          {
            data: [
              {% for material in top_materials_by_value %}
                {{ material.total_value }},
              {% endfor %}
            ],
            backgroundColor: generateColors({{ top_materials_by_value|length }}),
            borderWidth: 0
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              font: {
                family: "'Montserrat', sans-serif"
              }
            }
          }
        }
      }
    });
  });
</script>
{% endblock %}