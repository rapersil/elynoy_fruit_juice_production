{% extends 'juice_app/base.html' %}
{% load static %}
{% load custom_filters %}
{% block title %}Production Inventory Report | Fruit Juice Production{% endblock %}
{% block extra_css %}
<style>
  .report-card {
    transition: all 0.2s ease;
  }
  
  .report-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
  }
  
  .inventory-status {
    width: 12px;
    height: 12px;
    display: inline-block;
    border-radius: 50%;
    margin-right: 8px;
  }
  
  .status-good {
    background-color: var(--success);
  }
  
  .status-warning {
    background-color: var(--warning);
  }
  
  .status-critical {
    background-color: var(--danger);
  }
  
  .report-filters {
    background-color: var(--color-50);
    border-radius: 0.5rem;
    padding: 1.25rem;
    margin-bottom: 1.5rem;
  }
  
  .metric-box {
    background-color: var(--color-50);
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
    text-align: center;
  }
  
  .metric-value {
    font-size: 24px;
    font-weight: bold;
    color: var(--color-800);
    margin-bottom: 5px;
  }
  
  .metric-label {
    color: var(--color-600);
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  
  .progress-thin {
    height: 6px;
  }
  
  .tab-content {
    padding-top: 1.5rem;
  }
</style>
{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1>Production Inventory Report</h1>
    <p class="text-muted">Comprehensive view of current production inventory, materials, and products</p>
  </div>
  <div>
    <div class="dropdown d-inline-block me-2">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="material-icons align-middle">file_download</i> Export
      </button>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="exportDropdown">
        <li><a class="dropdown-item" href="#"><i class="material-icons align-middle me-2" style="font-size: 16px;">description</i> PDF</a></li>
        <li><a class="dropdown-item" href="#"><i class="material-icons align-middle me-2" style="font-size: 16px;">table_chart</i> Excel</a></li>
        <li><a class="dropdown-item" href="#"><i class="material-icons align-middle me-2" style="font-size: 16px;">print</i> Print</a></li>
      </ul>
    </div>
    <a href="{% url 'dashboard' %}" class="btn btn-outline-primary">
      <i class="material-icons align-middle">dashboard</i> Dashboard
    </a>
  </div>
</div>

<!-- Inventory Summary Cards -->
<div class="row mb-4">
  <div class="col-md-3 mb-3">
    <div class="card report-card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-1">Raw Materials Inventory</h6>
            <h2 class="mb-0">GHS{{ raw_materials_value|floatformat:2 }}</h2>
            <p class="text-muted mb-0">{{ raw_materials_count }} unique materials</p>
          </div>
          <div style="width: 48px; height: 48px; background-color: var(--color-100); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
            <i class="material-icons" style="font-size: 28px; color: var(--color-700);">inventory</i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card report-card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-1">In-Production Inventory</h6>
            <h2 class="mb-0">GHS{{ in_production_value|floatformat:2 }}</h2>
            <p class="text-muted mb-0">{{ active_batches_count }} active batches</p>
          </div>
          <div style="width: 48px; height: 48px; background-color: var(--color-100); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
            <i class="material-icons" style="font-size: 28px; color: var(--color-700);">science</i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card report-card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-1">Finished Products</h6>
            <h2 class="mb-0">GHS{{ products_value|floatformat:2 }}</h2>
            <p class="text-muted mb-0">{{ products_count }} unique products</p>
          </div>
          <div style="width: 48px; height: 48px; background-color: var(--color-100); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
            <i class="material-icons" style="font-size: 28px; color: var(--color-700);">local_drink</i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card report-card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-1">Total Inventory Value</h6>
            <h2 class="mb-0">GHS{{ total_inventory_value|floatformat:2 }}</h2>
            <p class="text-muted mb-0">As of {{ report_date }}</p>
          </div>
          <div style="width: 48px; height: 48px; background-color: var(--color-100); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
            <i class="material-icons" style="font-size: 28px; color: var(--color-700);">savings</i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Inventory Analysis Tabs -->
<div class="card mb-4">
  <div class="card-header">
    <ul class="nav nav-tabs card-header-tabs" id="inventoryTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">Overview</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="materials-tab" data-bs-toggle="tab" data-bs-target="#materials" type="button" role="tab" aria-controls="materials" aria-selected="false">Raw Materials</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="in-production-tab" data-bs-toggle="tab" data-bs-target="#in-production" type="button" role="tab" aria-controls="in-production" aria-selected="false">In Production</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab" aria-controls="products" aria-selected="false">Finished Products</button>
      </li>
    </ul>
  </div>
  <div class="card-body">
    <div class="tab-content" id="inventoryTabsContent">
      <!-- Overview Tab -->
      <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
        <div class="row">
          <div class="col-md-8">
            <h5 class="mb-3">Inventory Distribution</h5>
            <div style="height: 300px;">
              <canvas id="inventoryDistributionChart"></canvas>
            </div>
            <!-- Removed Inventory Value Trends section -->
          </div>
          <div class="col-md-4">
            <h5 class="mb-3">Top Items by Value</h5>
            {% if top_value_items %}
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Item</th>
                    <th>Type</th>
                    <th>Value</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in top_value_items %}
                  <tr>
                    <td>
                      {% if item.type == 'raw_material' %}
                      <a href="{% url 'raw_material_detail' item.id %}">{{ item.name }}</a>
                      {% elif item.type == 'product' %}
                      <a href="{% url 'product_detail' item.id %}">{{ item.name }}</a>
                      {% else %}
                      <a href="{% url 'production_detail' item.id %}">{{ item.name }}</a>
                      {% endif %}
                    </td>
                    <td>
                      {% if item.type == 'raw_material' %}
                      <span class="badge bg-secondary">Raw Material</span>
                      {% elif item.type == 'in_production' %}
                      <span class="badge bg-warning">In Production</span>
                      {% else %}
                      <span class="badge" style="background-color: var(--color-600);">Product</span>
                      {% endif %}
                    </td>
                    <td>GHS{{ item.total_value|floatformat:2 }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="text-center py-4">
              <p class="text-muted">No items found</p>
            </div>
            {% endif %}
        <h5 class="mt-4 mb-3">Low Stock Alert</h5>
        {% if low_stock_items %}
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Item</th>
                <th>Current/Reorder</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for item in low_stock_items %}
              <tr>
                <td>{{ item.name }}</td>
                <td class="text-danger fw-bold">{{ item.stock_quantity }}/{{ item.reorder_level }}</td>
                <td>
                  {% if item.type == 'raw_material' %}
                  <a href="{% url 'purchase_order_new' %}?material={{ item.id }}" class="btn btn-sm btn-outline-primary">
                    <i class="material-icons" style="font-size: 14px;">shopping_cart</i> Order
                  </a>
                  {% else %}
                  <a href="{% url 'production_new' %}?product={{ item.id }}" class="btn btn-sm btn-outline-primary">
                    <i class="material-icons" style="font-size: 14px;">science</i> Produce
                  </a>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center py-4">
          <p class="text-muted">No low stock items found</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- Raw Materials Tab -->
  <div class="tab-pane fade" id="materials" role="tabpanel" aria-labelledby="materials-tab">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">Raw Materials Inventory</h5>
      <div class="d-flex align-items-center">
        <div class="me-3">
          <span class="inventory-status status-good"></span> Normal
        </div>
        <div class="me-3">
          <span class="inventory-status status-warning"></span> Low
        </div>
        <div>
          <span class="inventory-status status-critical"></span> Critical
        </div>
      </div>
    </div>
    
    {% if raw_materials %}
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Name</th>
            <th>Current Stock</th>
            <th>Unit</th>
            <th>Reorder Level</th>
            <th>Unit Cost</th>
            <th>Total Value</th>
            <th>Status</th>
            <th>Last Purchase</th>
          </tr>
        </thead>
        <tbody>
          {% for material in raw_materials %}
          <tr>
            <td>
              <a href="{% url 'raw_material_detail' material.id %}">{{ material.name }}</a>
              {% if material.is_fruit %}
              <span class="badge bg-success">Fruit</span>
              {% endif %}
            </td>
            <td>{{ material.quantity_in_stock }}</td>
            <td>{{ material.unit }}</td>
            <td>{{ material.reorder_level }}</td>
            <td>GHS{{ material.unit_cost|floatformat:2 }}</td>
            <td>GHS{{ material.quantity_in_stock|multiply:material.unit_cost|floatformat:2 }}</td>
            <td>
              {% if material.quantity_in_stock == 0 %}
              <span class="inventory-status status-critical"></span> Out of Stock
              {% elif material.quantity_in_stock <= material.reorder_level %}
              <span class="inventory-status status-warning"></span> Low
              {% else %}
              <span class="inventory-status status-good"></span> Normal
              {% endif %}
            </td>
            <td>{{ material.last_purchase_date|default:"Never" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-center py-5">
      <i class="material-icons" style="font-size: 48px; color: var(--color-200);">inventory</i>
      <p class="mt-3 text-muted">No raw materials found</p>
      <a href="{% url 'raw_material_new' %}" class="btn btn-primary mt-2">Add Raw Material</a>
    </div>
    {% endif %}
  </div>
  
  <!-- In Production Tab -->
  <div class="tab-pane fade" id="in-production" role="tabpanel" aria-labelledby="in-production-tab">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">In-Production Inventory</h5>
      <a href="{% url 'production_new' %}" class="btn btn-primary btn-sm">
        <i class="material-icons align-middle" style="font-size: 16px;">add</i> New Batch
      </a>
    </div>
    
    {% if production_batches %}
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Batch Number</th>
            <th>Product</th>
            <th>Planned Quantity</th>
            <th>Production Date</th>
            <th>Status</th>
            <th>Materials Value</th>
            <th>Produced By</th>
          </tr>
        </thead>
        <tbody>
          {% for batch in production_batches %}
          <tr>
            <td>
              <a href="{% url 'production_detail' batch.id %}">{{ batch.batch_number }}</a>
            </td>
            <td>{{ batch.product.name }}</td>
            <td>{{ batch.planned_quantity }}</td>
            <td>{{ batch.production_date }}</td>
            <td>
              {% if batch.status == 'completed' %}
              <span class="badge bg-success">Completed</span>
              {% elif batch.status == 'in_progress' %}
              <span class="badge bg-warning">In Progress</span>
              {% elif batch.status == 'planned' %}
              <span class="badge bg-info">Planned</span>
              {% else %}
              <span class="badge bg-danger">Cancelled</span>
              {% endif %}
            </td>
            <td>GHS{{ batch.total_material_cost|floatformat:2 }}</td>
            <td>{{ batch.produced_by|default:"Not assigned" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-center py-5">
      <i class="material-icons" style="font-size: 48px; color: var(--color-200);">science</i>
      <p class="mt-3 text-muted">No active production batches</p>
      <a href="{% url 'production_new' %}" class="btn btn-primary mt-2">Start Production</a>
    </div>
    {% endif %}
  </div>
  
  <!-- Finished Products Tab -->
  <div class="tab-pane fade" id="products" role="tabpanel" aria-labelledby="products-tab">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">Finished Products Inventory</h5>
      <div class="d-flex align-items-center">
        <div class="me-3">
          <span class="inventory-status status-good"></span> In Stock
        </div>
        <div class="me-3">
          <span class="inventory-status status-warning"></span> Low Stock
        </div>
        <div>
          <span class="inventory-status status-critical"></span> Out of Stock
        </div>
      </div>
    </div>
    
    {% if products %}
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Product</th>
            <th>SKU</th>
            <th>Current Stock</th>
            <th>Bottle Size</th>
            <th>Production Cost</th>
            <th>Selling Price</th>
            <th>Markup</th>
            <th>Total Value</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for product in products %}
          <tr>
            <td>
              <a href="{% url 'product_detail' product.id %}">{{ product.name }}</a>
            </td>
            <td>{{ product.sku }}</td>
            <td>{{ product.stock_quantity }}</td>
            <td>{{ product.bottle.size }}</td>
            <td>GHS{{ product.production_cost|floatformat:2 }}</td>
            <td>GHS{{ product.selling_price|floatformat:2 }}</td>
            <td>{{ product.markup_percentage }}%</td>
            <td>GHS{{ product.stock_quantity|multiply:product.selling_price|floatformat:2 }}</td>
            <td>
              {% if product.stock_quantity == 0 %}
              <span class="inventory-status status-critical"></span> Out of Stock
              {% elif product.stock_quantity < 10 %}
              <span class="inventory-status status-warning"></span> Low
              {% else %}
              <span class="inventory-status status-good"></span> In Stock
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-center py-5">
      <i class="material-icons" style="font-size: 48px; color: var(--color-200);">local_drink</i>
      <p class="mt-3 text-muted">No products found</p>
      <a href="{% url 'product_new' %}" class="btn btn-primary mt-2">Add Product</a>
    </div>
    {% endif %}
  </div>
</div>
  </div>
</div>
<!-- Additional Analysis Section -->
<div class="row">
  <!-- Removed Inventory Turnover Analysis section -->
  <div class="col-md-12 mb-4">
    <div class="card h-100">
      <div class="card-header">
        <h5 class="mb-0">Production Efficiency</h5>
      </div>
      <div class="card-body">
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="metric-box">
              <div class="metric-value">{{ total_production_value|floatformat:2 }}</div>
              <div class="metric-label">Production Value (GHS)</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="metric-box">
              <div class="metric-value">{{ production_efficiency|floatformat:1 }}%</div>
              <div class="metric-label">Efficiency Rate</div>
            </div>
          </div>
        </div>
        <h6 class="mb-3">Top Products by Production Volume</h6>
        {% if top_produced_products %}
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Product</th>
                <th>Quantity Produced</th>
                <th>Efficiency</th>
                <th>Production Value</th>
              </tr>
            </thead>
            <tbody>
              {% for product in top_produced_products %}
              <tr>
                <td>{{ product.name }}</td>
                <td>{{ product.quantity_produced }}</td>
                <td>
                  <div class="progress progress-thin" style="width: 60px;">
                    <div class="progress-bar 
                      {% if product.efficiency >= 95 %}bg-success
                      {% elif product.efficiency >= 80 %}bg-warning
                      {% else %}bg-danger{% endif %}" 
                      style="width: {{ product.efficiency }}%;">
                    </div>
                  </div>
                  <small>{{ product.efficiency }}%</small>
                </td>
                <td>GHS{{ product.production_value|floatformat:2 }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center py-4">
          <p class="text-muted">No production data available</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Get CSS variables for chart colors
    const style = getComputedStyle(document.documentElement);
    const colorPrimary = style.getPropertyValue('--color-600');
    const colorSecondary = style.getPropertyValue('--color-400');
    const colorTertiary = style.getPropertyValue('--warning');
    
    // Inventory Distribution Chart
    const distributionCtx = document.getElementById('inventoryDistributionChart').getContext('2d');
    const inventoryDistributionChart = new Chart(distributionCtx, {
      type: 'bar',
      data: {
        labels: ['Raw Materials', 'In Production', 'Finished Products'],
        datasets: [
          {
            label: 'Inventory Value (GHS)',
            data: [{{ raw_materials_value }}, {{ in_production_value }}, {{ products_value }}],
            backgroundColor: [
              colorSecondary,
              colorTertiary,
              colorPrimary
            ],
            borderWidth: 0
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Value (GHS)',
              font: {
                family: "'Montserrat', sans-serif"
              }
            }
          }
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return 'GHS ' + context.raw.toFixed(2);
              }
            }
          }
        }
      }
    });
    
    

    
    
    // Initialize the tab functionality
    document.querySelectorAll('#inventoryTabs button').forEach(button => {
      button.addEventListener('click', function() {
        // Every time a tab is clicked, resize all charts to fix any display issues
        setTimeout(function() {
          inventoryDistributionChart.resize();
          inventoryTrendChart.resize();
          turnoverChart.resize();
        }, 50);
      });
    });
    
    // Handle automatic form submission when dropdowns change
    document.getElementById('inventory_type').addEventListener('change', function() {
      this.form.submit();
    });
    
    document.getElementById('status_filter').addEventListener('change', function() {
      this.form.submit();
    });
    
    document.getElementById('sort_by').addEventListener('change', function() {
      this.form.submit();
    });
  });
</script>
{% endblock %}