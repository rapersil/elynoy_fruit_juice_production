{% extends 'juice_app/base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ customer.name }} | Customer Details | Fruit Juice Production{% endblock %}

{% block extra_css %}
<style>
  .customer-header {
    background-color: var(--color-50);
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }
  
  .customer-avatar {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background-color: var(--color-600);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1.5rem;
  }
  
  .metric-card {
    transition: all 0.2s ease;
  }
  
  .metric-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
  }
  
  .credit-progress {
    height: 8px;
    border-radius: 4px;
  }
  
  .tab-content {
    padding: 1.5rem;
  }
  
  .timeline {
    position: relative;
    padding-left: 45px;
  }
  
  .timeline-item {
    position: relative;
    padding-bottom: 1.5rem;
  }
  
  .timeline-item:not(:last-child):before {
    content: '';
    position: absolute;
    left: -30px;
    top: 0;
    height: 100%;
    width: 2px;
    background-color: var(--color-200);
  }
  
  .timeline-icon {
    position: absolute;
    left: -45px;
    top: 0;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: var(--color-100);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .timeline-content {
    padding: 0.75rem;
    border-radius: 0.5rem;
    background-color: var(--color-50);
  }
  
  .product-preference {
    margin-bottom: 0.75rem;
    padding: 0.75rem;
    border-radius: 0.5rem;
    background-color: var(--color-50);
    transition: all 0.2s ease;
  }
  
  .product-preference:hover {
    background-color: var(--color-100);
  }
  
  .quick-action-btn {
    margin-bottom: 0.5rem;
  }
</style>
{% endblock %}

{% block content %}
<!-- Customer Header -->
<div class="customer-header">
  <div class="d-flex align-items-center">
    <div class="customer-avatar">
      <i class="material-icons" style="font-size: 48px; color: white;">
        {% if customer.is_supplier and customer.is_buyer %}business{% else %}
        {% if customer.is_supplier %}inventory{% else %}person{% endif %}{% endif %}
      </i>
    </div>
    <div class="flex-grow-1">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h1 class="mb-0">{{ customer.name }}</h1>
        <div>
          <a href="{% url 'customer_edit' customer.id %}" class="btn btn-primary">
            <i class="material-icons">edit</i> Edit
          </a>
          <a href="{% url 'sale_new' %}?customer={{ customer.id }}" class="btn btn-secondary">
            <i class="material-icons">point_of_sale</i> New Sale
          </a>
          <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#contactModal">
            <i class="material-icons">contact_mail</i> Contact
          </button>
        </div>
      </div>
      <div class="mb-2">
        {% if customer.is_buyer %}
        <span class="badge bg-primary">Buyer</span>
        {% endif %}
        {% if customer.is_supplier %}
        <span class="badge" style="background-color: var(--color-600);">Supplier</span>
        {% endif %}
        {% if customer.is_active %}
        <span class="badge bg-success">Active</span>
        {% else %}
        <span class="badge bg-secondary">Inactive</span>
        {% endif %}
        
        {% if first_purchase_date %}
        <span class="badge bg-info">Customer since {{ first_purchase_date|date:"F Y" }}</span>
        {% endif %}
      </div>
      <div class="d-flex">
        <div class="me-3">
          <i class="material-icons align-middle me-1">phone</i> {{ customer.phone }}
        </div>
        <div class="me-3">
          <i class="material-icons align-middle me-1">email</i> {{ customer.email }}
        </div>
        <div>
          <i class="material-icons align-middle me-1">person</i> {{ customer.contact_person }}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Key Metrics Row -->
<div class="row mb-4">
  {% if customer.is_buyer %}
  <div class="col-md-3 mb-3">
    <div class="card metric-card h-100">
      <div class="card-body">
        <h6 class="text-muted mb-2">Total Purchases</h6>
        <h3 class="mb-1">GHS{{ total_sales|floatformat:2 }}</h3>
        <p class="text-muted mb-0">{{ sales_count }} orders</p>
      </div>
    </div>
  </div>
  
  <div class="col-md-3 mb-3">
    <div class="card metric-card h-100">
      <div class="card-body">
        <h6 class="text-muted mb-2">Average Order</h6>
        <h3 class="mb-1">GHS{{ avg_order_value|floatformat:2 }}</h3>
        <p class="text-muted mb-0">Per order</p>
      </div>
    </div>
  </div>
  
  <div class="col-md-3 mb-3">
    <div class="card metric-card h-100">
      <div class="card-body">
        <h6 class="text-muted mb-2">Purchase Frequency</h6>
        <h3 class="mb-1">
          {% if purchase_frequency %}
          {{ purchase_frequency|floatformat:0 }} days
          {% else %}
          -
          {% endif %}
        </h3>
        <p class="text-muted mb-0">Between orders</p>
      </div>
    </div>
  </div>
  
  <div class="col-md-3 mb-3">
    <div class="card metric-card h-100">
      <div class="card-body">
        <h6 class="text-muted mb-2">Customer Value</h6>
        <h3 class="mb-1">GHS{{ customer_lifetime_value|floatformat:2 }}</h3>
        <p class="text-muted mb-0">Lifetime value</p>
      </div>
    </div>
  </div>
  {% else %}
  <div class="col-md-12">
    <div class="alert alert-info">
      <i class="material-icons align-middle me-2">info</i>
      This customer is registered as a supplier only. Activate the buyer role to track sales metrics.
    </div>
  </div>
  {% endif %}
</div>

<div class="row">
  <!-- Main Content Column -->
  <div class="col-md-8">
    <!-- Nav tabs -->
    <ul class="nav nav-tabs mb-3" id="customerTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">
          <i class="material-icons align-middle me-1">dashboard</i> Overview
        </button>
      </li>
      {% if customer.is_buyer %}
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="sales-tab" data-bs-toggle="tab" data-bs-target="#sales" type="button" role="tab" aria-controls="sales" aria-selected="false">
          <i class="material-icons align-middle me-1">shopping_cart</i> Sales History
        </button>
      </li>
      {% endif %}
      {% if customer.is_supplier %}
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="purchases-tab" data-bs-toggle="tab" data-bs-target="#purchases" type="button" role="tab" aria-controls="purchases" aria-selected="false">
          <i class="material-icons align-middle me-1">inventory</i> Purchase Orders
        </button>
      </li>
      {% endif %}
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments" type="button" role="tab" aria-controls="payments" aria-selected="false">
          <i class="material-icons align-middle me-1">payments</i> Payments
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="false">
          <i class="material-icons align-middle me-1">info</i> Details
        </button>
      </li>
    </ul>
    
    <!-- Tab content -->
    <div class="tab-content card">
      <!-- Overview Tab -->
      <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
        {% if customer.is_buyer and monthly_sales.months %}
        <h5 class="mb-4">Purchase Trends</h5>
        <div style="height: 300px;">
          <canvas id="purchaseTrendsChart"></canvas>
        </div>
        
        <hr class="my-4">
        {% endif %}
        
        <h5 class="mb-3">Recent Activity</h5>
        <div class="timeline">
          {% if sales %}
            {% for sale in sales|slice:":5" %}
            <div class="timeline-item">
              <div class="timeline-icon">
                <i class="material-icons" style="font-size: 16px; color: var(--color-600);">shopping_bag</i>
              </div>
              <div class="timeline-content">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0">Sale: {{ sale.invoice_number }}</h6>
                  <small>{{ sale.sale_date }}</small>
                </div>
                <p class="mb-2">Amount: <strong>GHS{{ sale.total_amount|floatformat:2 }}</strong></p>
                <div>
                  <span class="badge bg-{{ sale.status|title }}">{{ sale.status|title }}</span>
                  <span class="badge {% if sale.payment_status == 'paid' %}bg-success{% elif sale.payment_status == 'partial' %}bg-warning{% else %}bg-danger{% endif %}">
                    {{ sale.payment_status|title }}
                  </span>
                </div>
                <div class="mt-2">
                  <a href="{% url 'sale_detail' sale.id %}" class="btn btn-sm btn-outline-primary">View Details</a>
                </div>
              </div>
            </div>
            {% endfor %}
          {% elif purchase_orders %}
            {% for po in purchase_orders|slice:":5" %}
            <div class="timeline-item">
              <div class="timeline-icon">
                <i class="material-icons" style="font-size: 16px; color: var(--color-600);">inventory</i>
              </div>
              <div class="timeline-content">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0">Purchase Order: {{ po.po_number }}</h6>
                  <small>{{ po.order_date }}</small>
                </div>
                <p class="mb-2">Amount: <strong>GHS{{ po.total_amount|floatformat:2 }}</strong></p>
                <div>
                  <span class="badge bg-{{ po.status|title }}">{{ po.status|title }}</span>
                  <span class="badge {% if po.payment_status == 'paid' %}bg-success{% elif po.payment_status == 'partial' %}bg-warning{% else %}bg-danger{% endif %}">
                    {{ po.payment_status|title }}
                  </span>
                </div>
                <div class="mt-2">
                  <a href="{% url 'purchase_order_detail' po.id %}" class="btn btn-sm btn-outline-primary">View Details</a>
                </div>
              </div>
            </div>
            {% endfor %}
          {% else %}
          <div class="text-center py-4">
            <i class="material-icons" style="font-size: 48px; color: var(--color-200);">history</i>
            <p class="mt-3 text-muted">No recent activity</p>
          </div>
          {% endif %}
        </div>
      </div>
      
      <!-- Sales History Tab -->
      {% if customer.is_buyer %}
      <div class="tab-pane fade" id="sales" role="tabpanel" aria-labelledby="sales-tab">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h5 class="mb-0">Sales History</h5>
          <a href="{% url 'sale_new' %}?customer={{ customer.id }}" class="btn btn-sm btn-primary">
            <i class="material-icons align-middle me-1">add</i> New Sale
          </a>
        </div>
        
        {% if sales %}
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Invoice #</th>
                <th>Date</th>
                <th>Items</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Payment</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for sale in sales %}
              <tr>
                <td>
                  <a href="{% url 'sale_detail' sale.id %}">{{ sale.invoice_number }}</a>
                </td>
                <td>{{ sale.sale_date }}</td>
                <td>{{ sale.items.count }}</td>
                <td>GHS{{ sale.total_amount|floatformat:2 }}</td>
                <td>
                  {% if sale.status == 'draft' %}
                  <span class="badge bg-secondary">Draft</span>
                  {% elif sale.status == 'confirmed' %}
                  <span class="badge bg-primary">Confirmed</span>
                  {% elif sale.status == 'shipped' %}
                  <span class="badge bg-info">Shipped</span>
                  {% elif sale.status == 'delivered' %}
                  <span class="badge bg-success">Delivered</span>
                  {% else %}
                  <span class="badge bg-danger">Cancelled</span>
                  {% endif %}
                </td>
                <td>
                  {% if sale.payment_status == 'pending' %}
                  <span class="badge bg-warning">Pending</span>
                  {% elif sale.payment_status == 'partial' %}
                  <span class="badge bg-info">Partial</span>
                  {% elif sale.payment_status == 'paid' %}
                  <span class="badge bg-success">Paid</span>
                  {% else %}
                  <span class="badge bg-danger">Cancelled</span>
                  {% endif %}
                </td>
                <td>
                  <div class="btn-group">
                    <a href="{% url 'sale_detail' sale.id %}" class="btn btn-sm btn-outline-primary">
                      <i class="material-icons" style="font-size: 16px;">visibility</i>
                    </a>
                    {% if sale.status == 'draft' %}
                    <a href="{% url 'sale_edit' sale.id %}" class="btn btn-sm btn-outline-secondary">
                      <i class="material-icons" style="font-size: 16px;">edit</i>
                    </a>
                    {% endif %}
                    {% if sale.payment_status != 'paid' %}
                    <a href="{% url 'payment_add' sale.id %}" class="btn btn-sm btn-outline-success">
                      <i class="material-icons" style="font-size: 16px;">payments</i>
                    </a>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center py-5">
          <i class="material-icons" style="font-size: 48px; color: var(--color-200);">receipt_long</i>
          <p class="mt-3 text-muted">No sales history available</p>
          <a href="{% url 'sale_new' %}?customer={{ customer.id }}" class="btn btn-primary mt-2">Create First Sale</a>
        </div>
        {% endif %}
      </div>
      {% endif %}
      
      <!-- Purchase Orders Tab -->
      {% if customer.is_supplier %}
      <div class="tab-pane fade" id="purchases" role="tabpanel" aria-labelledby="purchases-tab">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h5 class="mb-0">Purchase Orders</h5>
          <a href="{% url 'purchase_order_new' %}?supplier={{ customer.id }}" class="btn btn-sm btn-primary">
            <i class="material-icons align-middle me-1">add</i> New Purchase Order
          </a>
        </div>
        
        {% if purchase_orders %}
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>PO #</th>
                <th>Date</th>
                <th>Items</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Payment</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for po in purchase_orders %}
              <tr>
                <td>
                  <a href="{% url 'purchase_order_detail' po.id %}">{{ po.po_number }}</a>
                </td>
                <td>{{ po.order_date }}</td>
                <td>{{ po.items.count }}</td>
                <td>GHS{{ po.total_amount|floatformat:2 }}</td>
                <td>
                  {% if po.status == 'draft' %}
                  <span class="badge bg-secondary">Draft</span>
                  {% elif po.status == 'submitted' %}
                  <span class="badge bg-primary">Submitted</span>
                  {% elif po.status == 'partial' %}
                  <span class="badge bg-warning">Partial</span>
                  {% elif po.status == 'received' %}
                  <span class="badge bg-success">Received</span>
                  {% else %}
                  <span class="badge bg-danger">Cancelled</span>
                  {% endif %}
                </td>
                <td>
                  {% if po.payment_status == 'pending' %}
                  <span class="badge bg-warning">Pending</span>
                  {% elif po.payment_status == 'partial' %}
                  <span class="badge bg-info">Partial</span>
                  {% elif po.payment_status == 'paid' %}
                  <span class="badge bg-success">Paid</span>
                  {% else %}
                  <span class="badge bg-danger">Cancelled</span>
                  {% endif %}
                </td>
                <td>
                  <div class="btn-group">
                    <a href="{% url 'purchase_order_detail' po.id %}" class="btn btn-sm btn-outline-primary">
                      <i class="material-icons" style="font-size: 16px;">visibility</i>
                    </a>
                    {% if po.status == 'draft' %}
                    <a href="{% url 'purchase_order_edit' po.id %}" class="btn btn-sm btn-outline-secondary">
                      <i class="material-icons" style="font-size: 16px;">edit</i>
                    </a>
                    {% endif %}
                    {% if po.status == 'submitted' or po.status == 'partial' %}
                    <a href="{% url 'purchase_order_receive' po.id %}" class="btn btn-sm btn-outline-success">
                      <i class="material-icons" style="font-size: 16px;">inventory</i>
                    </a>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center py-5">
          <i class="material-icons" style="font-size: 48px; color: var(--color-200);">local_shipping</i>
          <p class="mt-3 text-muted">No purchase orders available</p>
          <a href="{% url 'purchase_order_new' %}?supplier={{ customer.id }}" class="btn btn-primary mt-2">Create First Purchase Order</a>
        </div>
        {% endif %}
      </div>
      {% endif %}
      
      <!-- Payments Tab -->
      <div class="tab-pane fade" id="payments" role="tabpanel" aria-labelledby="payments-tab">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h5 class="mb-0">Payment History</h5>
          {% if customer.is_buyer and sales %}
          <a href="{% url 'sale_list' %}?customer={{ customer.id }}" class="btn btn-sm btn-primary">
            <i class="material-icons align-middle me-1">payments</i> Record Payment
          </a>
          {% endif %}
        </div>
        
        <div class="row">
          <div class="col-md-8">
            {% if payment_history %}
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Reference</th>
                    <th>Method</th>
                    <th>Amount</th>
                    <th>Invoice</th>
                  </tr>
                </thead>
                <tbody>
                  {% for payment in payment_history %}
                  <tr>
                    <td>{{ payment.payment_date }}</td>
                    <td>{{ payment.reference_number }}</td>
                    <td>{{ payment.get_payment_method_display }}</td>
                    <td>GHS{{ payment.amount|floatformat:2 }}</td>
                    <td>
                      <a href="{% url 'sale_detail' payment.sale.id %}">{{ payment.sale.invoice_number }}</a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
                <tfoot>
                  <tr class="table-secondary">
                    <th colspan="3">Total Payments</th>
                    <th>GHS{{ payment_totals|floatformat:2 }}</th>
                    <th></th>
                  </tr>
                </tfoot>
              </table>
            </div>
            {% else %}
            <div class="text-center py-5">
              <i class="material-icons" style="font-size: 48px; color: var(--color-200);">payments</i>
              <p class="mt-3 text-muted">No payment history available</p>
            </div>
            {% endif %}
          </div>
          
          <div class="col-md-4">
            {% if payment_methods %}
            <div class="card h-100">
              <div class="card-header">
                <h6 class="mb-0">Payment Methods</h6>
              </div>
              <div class="card-body">
                <div style="height: 200px;">
                  <canvas id="paymentMethodsChart"></canvas>
                </div>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      
      <!-- Details Tab -->
      <div class="tab-pane fade" id="details" role="tabpanel" aria-labelledby="details-tab">
        <h5 class="mb-3">Customer Information</h5>
        <div class="row">
          <div class="col-md-6">
            <table class="table">
              <tr>
                <th style="width: 40%;">Name</th>
                <td>{{ customer.name }}</td>
              </tr>
              <tr>
                <th>Contact Person</th>
                <td>{{ customer.contact_person }}</td>
              </tr>
              <tr>
                <th>Phone</th>
                <td>{{ customer.phone }}</td>
              </tr>
              <tr>
                <th>Email</th>
                <td>{{ customer.email }}</td>
              </tr>
              <tr>
                <th>Address</th>
                <td>{{ customer.address|linebreaksbr }}</td>
              </tr>
            </table>
          </div>
          
          <div class="col-md-6">
            <table class="table">
              <tr>
                <th style="width: 40%;">Customer Type</th>
                <td>
                  {% if customer.is_buyer and customer.is_supplier %}
                  Buyer & Supplier
                  {% elif customer.is_buyer %}
                  Buyer
                  {% elif customer.is_supplier %}
                  Supplier
                  {% endif %}
                </td>
              </tr>
              {% if customer.is_buyer %}
              <tr>
                <th>Credit Limit</th>
                <td>GHS{{ customer.credit_limit|floatformat:2 }}</td>
              </tr>
              {% endif %}
              <tr>
                <th>Payment Terms</th>
                <td>{{ customer.payment_terms|default:"Not specified" }}</td>
              </tr>
              <tr>
                <th>Status</th>
                <td>
                  {% if customer.is_active %}
                  <span class="badge bg-success">Active</span>
                  {% else %}
                  <span class="badge bg-secondary">Inactive</span>
                  {% endif %}
                </td>
              </tr>
              <tr>
                <th>Date Added</th>
                <td>{{ customer.date_added }}</td>
              </tr>
            </table>
          </div>
        </div>
        
        {% if customer.notes %}
        <h5 class="mt-4 mb-3">Notes</h5>
        <div class="card">
          <div class="card-body">
            {{ customer.notes|linebreaksbr }}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- Sidebar Column -->
  <div class="col-md-4">
    <!-- Credit Status Card (if buyer) -->
    {% if customer.is_buyer %}
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Credit Status</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-6 text-center">
            <h6 class="text-muted">Credit Used</h6>
            <h3 class="mb-0">GHS{{ credit_used|floatformat:2 }}</h3>
          </div>
          <div class="col-6 text-center">
            <h6 class="text-muted">Available</h6>
            <h3 class="mb-0">GHS{{ credit_available|floatformat:2 }}</h3>
          </div>
        </div>
        
        <div class="progress mt-3 credit-progress">
          <div class="progress-bar 
            {% if credit_percent < 50 %}bg-success
            {% elif credit_percent < 80 %}bg-warning
            {% else %}bg-danger{% endif %}" 
            role="progressbar" 
            style="width: {{ credit_percent }}%;" 
            aria-valuenow="{{ credit_percent }}" 
            aria-valuemin="0" 
            aria-valuemax="100">
          </div>
        </div>
        <div class="d-flex justify-content-between mt-1">
          <small class="text-muted">0%</small>
          <small class="text-muted">{{ credit_percent|floatformat:0 }}% Used</small>
          <small class="text-muted">100%</small>
        </div>
        
        <div class="mt-3">
          <a href="#" class="btn btn-sm btn-outline-primary">
            <i class="material-icons align-middle me-1">edit</i> Adjust Credit Limit
          </a>
        </div>
      </div>
    </div>
    
    <!-- Product Preferences -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Product Preferences</h5>
        <a href="{% url 'sale_new' %}?customer={{ customer.id }}" class="btn btn-sm btn-outline-primary">
          <i class="material-icons align-middle">add_shopping_cart</i> New Sale
        </a>
      </div>
      <div class="card-body">
        {% if purchased_products %}
        {% for product in purchased_products|slice:":5" %}
        <div class="product-preference">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-1">{{ product.product__name }}</h6>
            <small>{{ product.product__bottle__size }}</small>
          </div>
          <div class="d-flex justify-content-between">
            <div>Purchased {{ product.total_quantity }} units</div>
            <div>GHS{{ product.total_value|floatformat:2 }}</div>
          </div>
          <small class="text-muted">Last purchased: {{ product.last_purchase_date }}</small>
        </div>
        {% endfor %}
        {% else %}
        <div class="text-center py-4">
          <i class="material-icons" style="font-size: 36px; color: var(--color-200);">local_drink</i>
          <p class="mt-3 text-muted">No product history available</p>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
    
    <!-- Quick Actions -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Quick Actions</h5>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          {% if customer.is_buyer %}
          <a href="{% url 'sale_new' %}?customer={{ customer.id }}" class="btn btn-primary quick-action-btn">
            <i class="material-icons align-middle me-1">add_circle</i> Create New Sale
          </a>
          
          <a href="#" class="btn btn-outline-primary quick-action-btn" data-bs-toggle="modal" data-bs-target="#contactModal">
            <i class="material-icons align-middle me-1">email</i> Send Email
          </a>
          {% endif %}
          
          {% if customer.is_supplier %}
          <a href="{% url 'purchase_order_new' %}?supplier={{ customer.id }}" class="btn btn-primary quick-action-btn">
            <i class="material-icons align-middle me-1">add_circle</i> Create Purchase Order
          </a>
          {% endif %}
          
          <a href="{% url 'customer_edit' customer.id %}" class="btn btn-outline-secondary quick-action-btn">
            <i class="material-icons align-middle me-1">edit</i> Edit Customer
          </a>
          
          {% if customer.is_active %}
          <a href="#" class="btn btn-outline-danger quick-action-btn">
            <i class="material-icons align-middle me-1">block</i> Deactivate Customer
          </a>
          {% else %}
          <a href="#" class="btn btn-outline-success quick-action-btn">
            <i class="material-icons align-middle me-1">check_circle</i> Activate Customer
          </a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Contact Modal -->
<div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="contactModalLabel">Contact {{ customer.name }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label for="contact-subject" class="form-label">Subject</label>
            <input type="text" class="form-control" id="contact-subject">
          </div>
          <div class="mb-3">
            <label for="contact-message" class="form-label">Message</label>
            <textarea class="form-control" id="contact-message" rows="5"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary">Send Message</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Get CSS variables for chart colors
    const style = getComputedStyle(document.documentElement);
    const colorPrimary = style.getPropertyValue('--color-600');
    const colorSecondary = style.getPropertyValue('--color-300');
    
    {% if customer.is_buyer and monthly_sales.months %}
    // Purchase Trends Chart
    const trendsCtx = document.getElementById('purchaseTrendsChart').getContext('2d');
    const purchaseTrendsChart = new Chart(trendsCtx, {
      type: 'bar',
      data: {
        labels: {{ monthly_sales.months|safe }},
        datasets: [
          {
            label: 'Purchase Amount (GHS)',
            data: {{ monthly_sales.amounts|safe }},
            backgroundColor: 'rgba(200, 68, 58, 0.7)',
            borderColor: colorPrimary,
            borderWidth: 1,
            borderRadius: 4,
            yAxisID: 'y-amount'
          },
          {
            label: 'Order Count',
            data: {{ monthly_sales.counts|safe }},
            type: 'line',
            backgroundColor: 'transparent',
            borderColor: colorSecondary,
            borderWidth: 2,
            pointBackgroundColor: colorSecondary,
            yAxisID: 'y-count'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          'y-amount': {
            type: 'linear',
            position: 'left',
            beginAtZero: true,
            title: {
              display: true,
              text: 'Amount (GHS)',
            }
          },
          'y-count': {
            type: 'linear',
            position: 'right',
            beginAtZero: true,
            title: {
              display: true,
              text: 'Order Count',
            },
            grid: {
              drawOnChartArea: false,
            }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.datasetIndex === 0) {
                  label += 'GHS' + context.parsed.y.toFixed(2);
                } else {
                  label += context.parsed.y;
                }
                return label;
              }
            }
          }
        }
      }
    });
    {% endif %}
    
    {% if payment_methods %}
    // Payment Methods Chart
    const paymentMethodsCtx = document.getElementById('paymentMethodsChart').getContext('2d');
    const paymentMethodsData = {
      labels: [{% for method in payment_methods %}'{{ method.payment_method|title }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
      datasets: [{
        data: [{% for method in payment_methods %}{{ method.total }}{% if not forloop.last %}, {% endif %}{% endfor %}],
        backgroundColor: [
          '#4e73df',
          '#1cc88a',
          '#36b9cc',
          '#f6c23e',
          '#e74a3b',
          '#858796'
        ],
        borderWidth: 1
      }]
    };
    
    const paymentMethodsChart = new Chart(paymentMethodsCtx, {
      type: 'doughnut',
      data: paymentMethodsData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              font: {
                family: "'Montserrat', sans-serif"
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.label || '';
                let value = context.parsed || 0;
                let total = context.dataset.data.reduce((a, b) => a + b, 0);
                let percentage = Math.round((value / total) * 100);
                return `${label}: GHS${value.toFixed(2)} (${percentage}%)`;
              }
            }
          }
        }
      }
    });
    {% endif %}
  });
</script>
{% endblock %}